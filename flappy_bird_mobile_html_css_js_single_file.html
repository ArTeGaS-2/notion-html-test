<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Flappy (Mobile)</title>
  <style>
    :root {
      --bg: #70c5ce; /* небо */
      --ground: #ded09f; /* земля */
      --pipe: #34c759; /* труби */
      --pipe-dark: #2aa94a;
      --bird: #ffd34e; /* пташка */
      --text: #0b0b0b;
      --shadow: rgba(0,0,0,.2);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      background: var(--bg);
      display: grid; place-items: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif;
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }
    .wrap {
      position: relative; width: min(100vw, 520px); height: 72vh; max-height: 780px; aspect-ratio: 9/16;
      display: grid; place-items: center;
    }
    canvas {
      width: 100%; height: 100%;
      border-radius: 16px; box-shadow: 0 10px 30px var(--shadow);
      background: linear-gradient(#8dd9e8, var(--bg));
      touch-action: none; /* без скролу під час тапів */
    }
    .hud { position: absolute; inset: 0; pointer-events: none; display: grid; grid-template-rows: auto 1fr auto; }
    .topbar {
      display: flex; justify-content: space-between; align-items: center; padding: .6rem .8rem; gap: .5rem;
      font-weight: 700; text-transform: uppercase; letter-spacing: .03em;
      mix-blend-mode: multiply;
    }
    .pill { background: rgba(255,255,255,.65); padding: .35rem .6rem; border-radius: 999px; box-shadow: 0 2px 6px var(--shadow); }

    .center-msg { display: grid; place-items: center; }
    .card {
      pointer-events: auto; text-align: center; padding: .9rem 1rem; border-radius: 16px; background: rgba(255,255,255,.85);
      box-shadow: 0 6px 18px var(--shadow);
      backdrop-filter: blur(2px);
    }
    .title { margin: 0 0 .4rem; font-size: 1.25rem; }
    .sub { margin: 0 0 .7rem; opacity: .8; font-size: .95rem; }
    .row { display: flex; gap: .5rem; justify-content: center; }
    .btn {
      pointer-events: auto; -webkit-user-select: none; user-select: none;
      padding: .7rem 1rem; border-radius: 12px; border: 0; font-weight: 700; font-size: .95rem;
      background: #111; color: #fff; box-shadow: 0 6px 16px var(--shadow);
    }
    .btn.secondary { background: #fff; color: #111; outline: 1px solid rgba(0,0,0,.12); }

    .touch-hint { position: absolute; bottom: .6rem; left: 0; right: 0; text-align: center; opacity: .9; }
    .kbd { font-weight: 700; background: rgba(255,255,255,.8); padding: .1rem .4rem; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <canvas id="game" aria-label="Flappy Bird mini" role="img"></canvas>

    <div class="hud">
      <div class="topbar">
        <div class="pill">Очки: <span id="score">0</span></div>
        <div class="pill">Рекорд: <span id="best">0</span></div>
      </div>
      <div class="center-msg" id="menu">
        <div class="card" id="menuCard">
          <h2 class="title">Flappy</h2>
          <p class="sub">Тицяй екран, щоб змахувати. Уникай труб.</p>
          <div class="row">
            <button class="btn" id="playBtn">Грати</button>
            <button class="btn secondary" id="muteBtn">Звук: увімк</button>
          </div>
        </div>
      </div>
      <div class="touch-hint">Торкнись або натисни <span class="kbd">Space</span></div>
    </div>
  </div>

  <script>
    // --------------------------
    //   Налаштування гри
    // --------------------------
    const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1)); // для чіткості, але без надлишку
    const BASE_W = 360;              // логічна ширина арени
    const BASE_H = 640;              // логічна висота арени (9:16)
    const GRAVITY = 0.45;            // гравітація
    const FLAP = -7.8;               // імпульс при змаху
    const PIPE_GAP = 150;            // отвір між трубами
    const PIPE_W = 60;               // ширина труби
    const PIPE_SPEED = 2.6;          // швидкість прокрутки
    const PIPE_INTERVAL = 1500;      // мс між появами труб
    const GROUND_H = 80;             // висота землі
    const BIRD_R = 14;               // радіус пташки (коло для колізій)

    // Звук (простий, через WebAudio beeps)
    const SFX = {
      on: true,
      ctx: null,
      beep(freq=880, dur=0.06, vol=0.08){
        if(!this.on) return;
        try {
          this.ctx = this.ctx || new (window.AudioContext||window.webkitAudioContext)();
          const o = this.ctx.createOscillator();
          const g = this.ctx.createGain();
          o.type = 'square'; o.frequency.value = freq; g.gain.value = vol;
          o.connect(g); g.connect(this.ctx.destination);
          o.start(); o.stop(this.ctx.currentTime + dur);
        } catch(e){}
      }
    };

    const canvas = document.getElementById('game');
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const wrap = document.getElementById('wrap');
    const menu = document.getElementById('menu');
    const playBtn = document.getElementById('playBtn');
    const muteBtn = document.getElementById('muteBtn');

    let best = +localStorage.getItem('flappy_best') || 0; bestEl.textContent = best;

    // Підігнати реальний canvas під розмір контейнера
    function fitCanvas(){
      const rect = wrap.getBoundingClientRect();
      const w = rect.width, h = rect.height;
      // підтримуємо співвідношення 9:16 в межах контейнера
      const ratio = BASE_W/BASE_H;
      let cw = w, ch = w/ratio;
      if (ch > h) { ch = h; cw = h*ratio; }
      canvas.style.width = cw + 'px';
      canvas.style.height = ch + 'px';
      canvas.width = Math.round(cw * DPR);
      canvas.height = Math.round(ch * DPR);
      ctx.setTransform(canvas.width/BASE_W, 0, 0, canvas.height/BASE_H, 0, 0); // масштаб у логічні одиниці
    }

    const ctx = canvas.getContext('2d');
    fitCanvas();
    addEventListener('resize', fitCanvas);

    // Стан гри
    let running = false, gameOver = false, lastSpawn = 0, lastTime = 0;
    let score = 0;
    const bird = { x: BASE_W*0.28, y: BASE_H*0.45, vy: 0, r: BIRD_R };
    const pipes = []; // масив труб {x, topH}

    function reset(){
      score = 0; scoreEl.textContent = score;
      bird.x = BASE_W*0.28; bird.y = BASE_H*0.45; bird.vy = 0;
      pipes.length = 0; lastSpawn = 0; lastTime = 0; gameOver = false;
    }

    function flap(){
      if(!running){ start(); return; }
      if(gameOver){ reset(); running = true; return; }
      bird.vy = FLAP; SFX.beep(900, .05, .06);
    }

    function start(){
      reset(); running = true; menu.style.display = 'none';
      requestAnimationFrame(loop);
    }

    function end(){
      running = false; gameOver = true; SFX.beep(220, .15, .08);
      best = Math.max(best, score); localStorage.setItem('flappy_best', best);
      bestEl.textContent = best;
      // показати меню з кнопкою «Грати знову»
      const title = document.querySelector('#menu .title');
      const sub = document.querySelector('#menu .sub');
      title.textContent = 'Кінець гри';
      sub.textContent = `Рахунок: ${score}  ·  Рекорд: ${best}`;
      menu.style.display = 'grid';
    }

    function spawnPipe(){
      // Випадкове положення отвору в межах екрана
      const marginTop = 40, marginBottom = GROUND_H + 40;
      const gapY = Math.random()*(BASE_H - marginTop - marginBottom - PIPE_GAP) + marginTop;
      pipes.push({ x: BASE_W + 10, topH: gapY });
    }

    function rectsOverlap(ax, ay, aw, ah, bx, by, bw, bh){
      return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
    }

    function loop(ts){
      if(!running) return;
      const dt = Math.min(32, ts - (lastTime||ts));
      lastTime = ts; lastSpawn += dt;

      // Фізика пташки
      bird.vy += GRAVITY; bird.y += bird.vy * (dt/16);

      // Спавн труб
      if(lastSpawn > PIPE_INTERVAL){ spawnPipe(); lastSpawn = 0; }

      // Оновити/зсунути труби
      for(let i=0;i<pipes.length;i++) pipes[i].x -= PIPE_SPEED * (dt/16);
      // Прибрати поза екраном, додати очки коли пройшли трубу
      for(let i=pipes.length-1;i>=0;i--){
        const p = pipes[i];
        if(p.x + PIPE_W < bird.x && !p.scored){ p.scored = true; score++; scoreEl.textContent = score; SFX.beep(1200,.04,.05); }
        if(p.x + PIPE_W < -20) pipes.splice(i,1);
      }

      // Колізії з трубами/землею/небом
      const birdBox = { x: bird.x-bird.r, y: bird.y-bird.r, w: bird.r*2, h: bird.r*2 };
      for(const p of pipes){
        const topRect = { x:p.x, y:0, w:PIPE_W, h:p.topH };
        const botRect = { x:p.x, y:p.topH+PIPE_GAP, w:PIPE_W, h:BASE_H - (p.topH+PIPE_GAP) };
        if(rectsOverlap(birdBox.x,birdBox.y,birdBox.w,birdBox.h, topRect.x,topRect.y,topRect.w,topRect.h) ||
           rectsOverlap(birdBox.x,birdBox.y,birdBox.w,birdBox.h, botRect.x,botRect.y,botRect.w,botRect.h)){
          end();
        }
      }
      if(bird.y + bird.r > BASE_H - GROUND_H){ bird.y = BASE_H - GROUND_H - bird.r; end(); }
      if(bird.y - bird.r < 0){ bird.y = bird.r; }

      // Малювання
      draw();

      if(running) requestAnimationFrame(loop);
    }

    function drawBackground(){
      // Проста земля
      ctx.fillStyle = '#9bd769';
      ctx.fillRect(0, BASE_H - GROUND_H, BASE_W, GROUND_H);
      ctx.fillStyle = 'rgba(0,0,0,.05)';
      for(let x=0;x<BASE_W;x+=24){
        ctx.fillRect(x, BASE_H - GROUND_H + 12, 16, 6);
      }
    }

    function drawPipes(){
      for(const p of pipes){
        // Труба верх
        ctx.fillStyle = 'var(--pipe)';
        ctx.fillRect(p.x, 0, PIPE_W, p.topH);
        ctx.fillStyle = 'var(--pipe-dark)';
        ctx.fillRect(p.x, p.topH-14, PIPE_W, 14);
        // Труба низ
        const y2 = p.topH + PIPE_GAP;
        ctx.fillStyle = 'var(--pipe)';
        ctx.fillRect(p.x, y2, PIPE_W, BASE_H - y2);
        ctx.fillStyle = 'var(--pipe-dark)';
        ctx.fillRect(p.x, y2, PIPE_W, 14);
      }
    }

    function drawBird(){
      // Тіло (коло)
      ctx.save();
      const angle = Math.max(-0.5, Math.min(0.6, bird.vy/10));
      ctx.translate(bird.x, bird.y);
      ctx.rotate(angle);
      ctx.fillStyle = 'var(--bird)';
      ctx.beginPath(); ctx.arc(0, 0, bird.r, 0, Math.PI*2); ctx.fill();
      // крило
      ctx.fillStyle = 'rgba(0,0,0,.15)';
      ctx.beginPath(); ctx.ellipse(-2, 0, bird.r*0.7, bird.r*0.5, 0, 0, Math.PI*2); ctx.fill();
      // око
      ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(5, -4, 4, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(6, -4, 2, 0, Math.PI*2); ctx.fill();
      // дзьоб
      ctx.fillStyle = '#ff8c00'; ctx.beginPath(); ctx.moveTo(bird.r-2, -1); ctx.lineTo(bird.r+8, 2); ctx.lineTo(bird.r-2, 5); ctx.closePath(); ctx.fill();
      ctx.restore();
    }

    function draw(){
      ctx.clearRect(0,0,BASE_W,BASE_H);
      drawBackground();
      drawPipes();
      drawBird();
    }

    // Керування: тач/клік/клавіша
    canvas.addEventListener('pointerdown', flap);
    addEventListener('keydown', e=>{ if(e.code==='Space') { e.preventDefault(); flap(); } });
    playBtn.addEventListener('click', start);
    muteBtn.addEventListener('click', ()=>{
      SFX.on = !SFX.on; muteBtn.textContent = `Звук: ${SFX.on? 'увімк' : 'вимк'}`;
      if(SFX.on) SFX.beep(1000,.04,.05);
    });

    // Стартовий рендер (статичний екран)
    draw();
  </script>
</body>
</html>
